import{d as x,u as S,r as m,C as B,y as C,w as g,J as D,K as M,a as $,e as F,l as I,m as L,g as T,i as p,q as z,p as H}from"./index-B1IDC1yT.js";const W=["readonly","placeholder"],j=x({__name:"MemoWidget",props:{widget:{}},setup(n){const o=n,l=S(),i=m(!1),s=m(""),d=B(`flatnas-memo-backup-${o.widget.id}`,"");let u=!1;const v=D(async()=>{l.isLogged&&(Reflect.set(o.widget,"data",s.value),await l.saveWidget(o.widget.id,s.value),l.socket.emit("memo:update",{token:l.token||localStorage.getItem("flat-nas-token"),widgetId:o.widget.id,content:s.value}))},1e3);C(()=>{d.value?s.value=d.value:o.widget.data&&(s.value=o.widget.data)}),g(s,e=>{typeof e=="string"&&(d.value=e,u||v())}),g(()=>o.widget.data,e=>{if(typeof e=="string"&&e!==s.value){if(i.value)return;u=!0,s.value=e,d.value=e,u=!1}},{immediate:!0});const w=e=>{const t=e.currentTarget,{scrollTop:a,scrollHeight:r,clientHeight:c}=t,f=e.deltaY,k=a<=0,b=a+c>=r-1;(k&&f<0||b&&f>0)&&(e.preventDefault(),e.stopPropagation())},{pause:y,resume:h}=M(async()=>{if(l.isLogged&&!i.value)try{const e=l.getHeaders(),t=await fetch(`/api/widgets/${o.widget.id}`,{headers:e});if(t.ok){const a=await t.json();if(a&&typeof a.data=="string"&&a.data!==o.widget.data){const r=l.widgets.find(c=>c.id===o.widget.id);r&&(r.data=a.data)}}}catch(e){console.error("Memo polling failed",e)}},3e4,{immediate:!1});return g(i,e=>{e?y():h()},{immediate:!0}),(e,t)=>(F(),$("div",{class:H(["w-full h-full p-4 rounded-2xl backdrop-blur border border-white/10 relative group",n.widget.textColor?"":"text-gray-700"]),style:z({backgroundColor:`rgba(254, 249, 195, ${n.widget.opacity??.9})`,color:n.widget.textColor})},[I(T("textarea",{readonly:!p(l).isLogged,"onUpdate:modelValue":t[0]||(t[0]=a=>s.value=a),onFocus:t[1]||(t[1]=a=>i.value=!0),onBlur:t[2]||(t[2]=a=>i.value=!1),onWheel:w,class:"w-full h-full bg-transparent resize-none outline-none text-sm placeholder-gray-600 font-medium",placeholder:p(l).isLogged?"写点什么...":"请先登录"},null,40,W),[[L,s.value]])],6))}});export{j as default};
