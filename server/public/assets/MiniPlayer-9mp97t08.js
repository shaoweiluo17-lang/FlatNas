import{d as V,u as j,r as n,C as z,w as f,x as U,y as H,o as W,a as w,e as m,g as l,q as I,t as E,_ as $}from"./index-DetE_Czq.js";const D={class:"h-10 w-10 xl:w-[160px] px-0 rounded-full bg-transparent flex items-center gap-2 transition-all group select-none relative left-0 xl:-left-[5px]"},G=["src"],X={key:0,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",class:"w-6 h-6"},F={key:1,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",class:"w-6 h-6 pl-0.5"},J=["title"],K={class:"flex items-center w-full pr-0"},N={class:"text-[12px] opacity-70 origin-left truncate w-auto mr-auto"},O={class:"flex items-center gap-0.5 flex-shrink-0 origin-right"},Q=["disabled"],Y=V({__name:"MiniPlayer",setup(Z){const r=j(),a=n(!1),s=n(null),L=z("flat-nas-music-volume",.7),v=n([]),o=n("加载中..."),y=n(null),g=n(null),d=n(!1),x=n("3s"),M=n("0px");f(()=>r.activeMusicPlayer,e=>{e!=="mini-player"&&a.value&&(s.value&&s.value.pause(),a.value=!1)});const c=n([]),i=n(-1),T=e=>{if(!e||e==="加载中..."||e==="无音乐")return;const t=`/music/${e.split("/").map(u=>encodeURIComponent(u).replace(/'/g,"%27")).join("/")}`;return r.getAssetUrl(t)},S=async()=>{try{const t=await(await fetch("/api/music-list")).json();if(t.length>0){v.value=t;const u=t[Math.floor(Math.random()*t.length)];o.value=u,c.value=[u],i.value=0,r.appConfig.autoPlayMusic&&setTimeout(()=>{p()},1e3)}else o.value="无音乐"}catch{o.value="获取失败"}},_=()=>{if(!(v.value.length<=1)){if(i.value<c.value.length-1)i.value++,o.value=c.value[i.value]||"";else{let e=o.value;for(;e===o.value;)e=v.value[Math.floor(Math.random()*v.value.length)]||"";o.value=e,c.value.push(e),i.value++}p()}},q=()=>{i.value>0&&(i.value--,o.value=c.value[i.value]||"",p())},p=()=>{setTimeout(()=>{if(s.value){s.value.load();const e=s.value.play();e!==void 0&&e.then(()=>{a.value=!0,r.activeMusicPlayer="mini-player"}).catch(t=>{console.error("[MiniPlayer] Play failed:",t),a.value=!1})}},100)},A=e=>{const t=e.target;console.error("[MiniPlayer] Audio error:",t.error,t.src),a.value=!1},B=async()=>{const e=s.value;if(e)if(a.value)e.pause(),a.value=!1;else try{e.error&&e.load(),await e.play(),a.value=!0,r.activeMusicPlayer="mini-player"}catch(t){console.error("[MiniPlayer] Toggle play failed:",t),e.load()}},b=()=>{const e=y.value,t=g.value;if(!e||!t){d.value=!1;return}const u=t.scrollWidth-e.clientWidth;if(u>0&&a.value){d.value=!0;const R=Math.max(u/50,2);x.value=R+"s",M.value="-"+u+"px"}else d.value=!1};f([o,a],async()=>{await U(),b()}),f(L,e=>{s.value&&(s.value.volume=Math.max(0,Math.min(1,e)))},{immediate:!0});let h,k=!1;const P=async()=>{if(!r.appConfig.autoPlayMusic)return;const e=s.value;if(e)try{e.load(),await e.play(),a.value=!0}catch{C()}},C=()=>{if(k)return;k=!0;const e=async()=>{await P(),t()},t=()=>{window.removeEventListener("pointerdown",e),window.removeEventListener("touchstart",e),window.removeEventListener("keydown",e),document.removeEventListener("click",e)};window.addEventListener("pointerdown",e,{once:!0}),window.addEventListener("touchstart",e,{once:!0}),window.addEventListener("keydown",e,{once:!0}),document.addEventListener("click",e,{once:!0})};return H(()=>{console.log("[MiniPlayer] Mounted"),h=setTimeout(()=>{S(),setTimeout(b,200)},500),r.appConfig.autoPlayMusic&&C()}),W(()=>{console.log("[MiniPlayer] Unmounted"),h&&clearTimeout(h)}),f(()=>r.appConfig.autoPlayMusic,async e=>{e&&await P()},{immediate:!1}),(e,t)=>(m(),w("div",D,[l("audio",{ref_key:"audioRef",ref:s,preload:"none",src:T(o.value),onEnded:_,onError:A},null,40,G),l("button",{onClick:B,class:"w-10 h-10 flex-shrink-0 rounded-full bg-white/20 flex items-center justify-center hover:bg-white/40 hover:text-white transition-all active:scale-95 text-white backdrop-blur border border-white/20 shadow-sm"},[a.value?(m(),w("svg",X,[...t[0]||(t[0]=[l("path",{"fill-rule":"evenodd",d:"M6.75 5.25a.75.75 0 01.75-.75H9a.75.75 0 01.75.75v13.5a.75.75 0 01-.75.75H7.5a.75.75 0 01-.75-.75V5.25zm7.5 0A.75.75 0 0115 4.5h1.5a.75.75 0 01.75.75v13.5a.75.75 0 01-.75.75H15a.75.75 0 01-.75-.75V5.25z","clip-rule":"evenodd"},null,-1)])])):(m(),w("svg",F,[...t[1]||(t[1]=[l("path",{"fill-rule":"evenodd",d:"M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.712 1.295 2.573 0 3.285L7.28 19.991c-1.25.687-2.779-.217-2.779-1.643V5.653z","clip-rule":"evenodd"},null,-1)])]))]),l("div",{ref_key:"titleWrapRef",ref:y,class:"flex-1 overflow-hidden text-xs font-medium text-white text-shadow hidden xl:flex flex-col justify-center min-w-0 h-full py-0.5",title:o.value},[l("span",{ref_key:"titleTextRef",ref:g,class:"",style:I(d.value?{"--marquee-to":M.value,animation:`marqueeX ${x.value} linear infinite alternate`,display:"inline-block",whiteSpace:"nowrap"}:{whiteSpace:"nowrap"})},E(o.value.replace(/\.(mp3|flac|wav|m4a)$/i,"")),5),l("div",K,[l("span",N,E(a.value?"正在播放":"已暂停"),1),l("div",O,[l("button",{onClick:q,class:"w-6 h-6 rounded-full flex items-center justify-center text-white/80 hover:text-white hover:bg-white/20 transition-all disabled:opacity-30 disabled:hover:bg-transparent disabled:cursor-not-allowed",title:"上一首",disabled:i.value<=0},[...t[2]||(t[2]=[l("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",class:"w-4 h-4"},[l("path",{d:"M9.195 18.44c1.25.713 2.805-.19 2.805-1.629v-2.81l7.82 4.466c1.25.713 2.805-.19 2.805-1.629V7.162c0-1.44-1.555-2.342-2.805-1.628l-7.82 4.466v-2.81c0-1.44-1.555-2.343-2.805-1.629l-7.108 4.062c-1.26.72-1.26 2.536 0 3.256l7.108 4.061z"})],-1)])],8,Q),l("button",{onClick:_,class:"w-6 h-6 rounded-full flex items-center justify-center text-white/80 hover:text-white hover:bg-white/20 transition-all",title:"下一首"},[...t[3]||(t[3]=[l("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",class:"w-4 h-4"},[l("path",{d:"M5.055 7.06C3.805 6.347 2.25 7.25 2.25 8.69v8.122c0 1.44 1.555 2.342 2.805 1.628L12.875 14v2.81c0 1.44 1.555 2.343 2.805 1.629l7.108-4.061c1.26-.72 1.26-2.536 0-3.256l-7.108-4.062c-1.25-.713-2.805.19-2.805 1.629V11.5L5.055 7.06z"})],-1)])])])])],8,J)]))}}),te=$(Y,[["__scopeId","data-v-025c8795"]]);export{te as default};
